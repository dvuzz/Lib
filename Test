local library = {flags = {}, windows = {}, open = true}

local blacklistedKeys = {
    Enum.KeyCode.Unknown,
    Enum.KeyCode.W,
    Enum.KeyCode.A,
    Enum.KeyCode.S,
    Enum.KeyCode.D,
    Enum.KeyCode.Space,
    Enum.KeyCode.LeftShift,
    Enum.KeyCode.RightShift,
    Enum.KeyCode.LeftControl,
    Enum.KeyCode.RightControl,
    Enum.KeyCode.LeftAlt,
    Enum.KeyCode.RightAlt
}

local whitelistedMouseinputs = {
    Enum.UserInputType.MouseButton1,
    Enum.UserInputType.MouseButton2,
    Enum.UserInputType.MouseButton3
}

--Services
local runService = game:GetService"RunService"
local tweenService = game:GetService"TweenService"
local textService = game:GetService"TextService"
local inputService = game:GetService"UserInputService"
local ui = Enum.UserInputType.MouseButton1
--Locals
local dragging, dragInput, dragStart, startPos, dragObject

--Functions
local function round(num, bracket)
	bracket = bracket or 1
	local a = math.floor(num/bracket + (math.sign(num) * 0.5)) * bracket
	if a < 0 then
		a = a + bracket
	end
	return a
end

local function keyCheck(x,x1)
	for _,v in next, x1 do
		if v == x then
			return true
		end
	end
end

local function update(input)
	local delta = input.Position - dragStart
	local yPos = (startPos.Y.Offset + delta.Y) < -36 and -36 or startPos.Y.Offset + delta.Y
	dragObject:TweenPosition(UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, yPos), "Out", "Quint", 0.1, true)
end
 
--From: https://devforum.roblox.com/t/how-to-create-a-simple-rainbow-effect-using-tweenService/221849/2
local chromaColor
local rainbowTime = 5
spawn(function()
	while wait() do
		chromaColor = Color3.fromHSV(tick() % rainbowTime / rainbowTime, 1, 1)
	end
end)

function library:Create(class, properties)
	properties = typeof(properties) == "table" and properties or {}
	local inst = Instance.new(class)
	for property, value in next, properties do
		inst[property] = value
	end
	return inst
end

local function createOptionHolder(holderTitle, parent, parentTable, subHolder)
	local size = subHolder and 34 or 40
	parentTable.main = library:Create("ImageButton", {
		LayoutOrder = subHolder and parentTable.position or 0,
		Position = UDim2.new(0, 20 + (250 * (parentTable.position or 0)), 0, 20),
		Size = UDim2.new(0, 230, 0, size),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(20, 20, 20),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.04,
		ClipsDescendants = true,
		Parent = parent
	})
	
	local round
	if not subHolder then
		round = library:Create("ImageLabel", {
			Size = UDim2.new(1, 0, 0, size),
			BackgroundTransparency = 1,
			Image = "rbxassetid://3570695787",
			ImageColor3 = parentTable.open and (subHolder and Color3.fromRGB(16, 16, 16) or Color3.fromRGB(10, 10, 10)) or (subHolder and Color3.fromRGB(10, 10, 10) or Color3.fromRGB(6, 6, 6)),
			ScaleType = Enum.ScaleType.Slice,
			SliceCenter = Rect.new(100, 100, 100, 100),
			SliceScale = 0.04,
			Parent = parentTable.main
		})
	end
	
	local title = library:Create("TextLabel", {
		Size = UDim2.new(1, 0, 0, size),
		BackgroundTransparency = subHolder and 0 or 1,
		BackgroundColor3 = Color3.fromRGB(10, 10, 10),
		BorderSizePixel = 0,
		Text = holderTitle,
		TextSize = subHolder and 16 or 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Parent = parentTable.main
	})
	
	local closeHolder = library:Create("Frame", {
		Position = UDim2.new(1, 0, 0, 0),
		Size = UDim2.new(-1, 0, 1, 0),
		SizeConstraint = Enum.SizeConstraint.RelativeYY,
		BackgroundTransparency = 1,
		Parent = title
	})
	
	local close = library:Create("ImageLabel", {
		AnchorPoint = Vector2.new(0.5, 0.5),
		Position = UDim2.new(0.5, 0, 0.5, 0),
		Size = UDim2.new(1, -size - 10, 1, -size - 10),
		Rotation = parentTable.open and 90 or 180,
		BackgroundTransparency = 1,
		Image = "rbxassetid://4918373417",
		ImageColor3 = parentTable.open and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30),
		ScaleType = Enum.ScaleType.Fit,
		Parent = closeHolder
	})
	
	parentTable.content = library:Create("Frame", {
		Position = UDim2.new(0, 0, 0, size),
		Size = UDim2.new(1, 0, 1, -size),
		BackgroundTransparency = 1,
		Parent = parentTable.main
	})
	
	local layout = library:Create("UIListLayout", {
		SortOrder = Enum.SortOrder.LayoutOrder,
		Parent = parentTable.content
	})
	
	layout.Changed:connect(function()
		parentTable.content.Size = UDim2.new(1, 0, 0, layout.AbsoluteContentSize.Y)
		parentTable.main.Size = #parentTable.options > 0 and parentTable.open and UDim2.new(0, 230, 0, layout.AbsoluteContentSize.Y + size) or UDim2.new(0, 230, 0, size)
	end)
	
	if not subHolder then
		library:Create("UIPadding", {
			Parent = parentTable.content
		})
		
		title.InputBegan:connect(function(input)
			if input.UserInputType == ui then
				dragObject = parentTable.main
				dragging = true
				dragStart = input.Position
				startPos = dragObject.Position
			elseif input.UserInputType == Enum.UserInputType.Touch then
				dragObject = parentTable.main
				dragging = true
				dragStart = input.Position
				startPos = dragObject.Position
			end
		end)
		title.InputChanged:connect(function(input)
			if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
				dragInput = input
			elseif dragging and input.UserInputType == Enum.UserInputType.Touch then
				dragInput = input
			end
		end)
			title.InputEnded:connect(function(input)
			if input.UserInputType == ui then
				dragging = false
			elseif input.UserInputType == Enum.UserInputType.Touch then
				dragging = false
			end
		end)
	end
	
	closeHolder.InputBegan:connect(function(input)
		if input.UserInputType == ui then
			parentTable.open = not parentTable.open
			tweenService:Create(close, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Rotation = parentTable.open and 90 or 180, ImageColor3 = parentTable.open and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30)}):Play()
			if subHolder then
				tweenService:Create(title, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = parentTable.open and Color3.fromRGB(16, 16, 16) or Color3.fromRGB(10, 10, 10)}):Play()
			else
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = parentTable.open and Color3.fromRGB(10, 10, 10) or Color3.fromRGB(6, 6, 6)}):Play()
			end
			parentTable.main:TweenSize(#parentTable.options > 0 and parentTable.open and UDim2.new(0, 230, 0, layout.AbsoluteContentSize.Y + size) or UDim2.new(0, 230, 0, size), "Out", "Quad", 0.2, true)
		elseif input.UserInputType == Enum.UserInputType.Touch then
			parentTable.open = not parentTable.open
			tweenService:Create(close, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Rotation = parentTable.open and 90 or 180, ImageColor3 = parentTable.open and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30)}):Play()
			if subHolder then
				tweenService:Create(title, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = parentTable.open and Color3.fromRGB(16, 16, 16) or Color3.fromRGB(10, 10, 10)}):Play()
			else
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = parentTable.open and Color3.fromRGB(10, 10, 10) or Color3.fromRGB(6, 6, 6)}):Play()
			end
			parentTable.main:TweenSize(#parentTable.options > 0 and parentTable.open and UDim2.new(0, 230, 0, layout.AbsoluteContentSize.Y + size) or UDim2.new(0, 230, 0, size), "Out", "Quad", 0.2, true)
		end
	end)

	function parentTable:SetTitle(newTitle)
		title.Text = tostring(newTitle)
	end
	
	return parentTable
end
	
local function createLabel(option, parent)
	local main = library:Create("TextLabel", {
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 26),
		BackgroundTransparency = 1,
		Text = " " .. option.text,
		TextSize = 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		TextXAlignment = Enum.TextXAlignment.Left,
		Parent = parent.content
	})
	
	setmetatable(option, {__newindex = function(t, i, v)
		if i == "Text" then
			main.Text = " " .. tostring(v)
		end
	end})
end

function createToggle(option, parent)
	local main = library:Create("TextLabel", {
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 31),
		BackgroundTransparency = 1,
		Text = " " .. option.text,
		TextSize = 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		TextXAlignment = Enum.TextXAlignment.Left,
		Parent = parent.content
	})
	
	local tickboxOutline = library:Create("ImageLabel", {
		Position = UDim2.new(1, -6, 0, 4),
		Size = UDim2.new(-1, 10, 1, -10),
		SizeConstraint = Enum.SizeConstraint.RelativeYY,
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = option.state and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(100, 100, 100),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local tickboxInner = library:Create("ImageLabel", {
		Position = UDim2.new(0, 2, 0, 2),
		Size = UDim2.new(1, -4, 1, -4),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = option.state and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(20, 20, 20),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = tickboxOutline
	})
	
	local checkmarkHolder = library:Create("Frame", {
		Position = UDim2.new(0, 4, 0, 4),
		Size = option.state and UDim2.new(1, -8, 1, -8) or UDim2.new(0, 0, 1, -8),
		BackgroundTransparency = 1,
		ClipsDescendants = true,
		Parent = tickboxOutline
	})
	
	local checkmark = library:Create("ImageLabel", {
		Size = UDim2.new(1, 0, 1, 0),
		SizeConstraint = Enum.SizeConstraint.RelativeYY,
		BackgroundTransparency = 1,
		Image = "rbxassetid://4919148038",
		ImageColor3 = Color3.fromRGB(20, 20, 20),
		Parent = checkmarkHolder
	})
	
	local inContact
	main.InputBegan:connect(function(input)
		if input.UserInputType == ui then
			option:SetState(not option.state)
		elseif input.UserInputType == Enum.UserInputType.Touch then
			option:SetState(not option.state)
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			if not option.state then
				tweenService:Create(tickboxOutline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(140, 140, 140)}):Play()
			end
		end
	end)
	
	main.InputEnded:connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			if not option.state then
				tweenService:Create(tickboxOutline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			end
		end
	end)
	
	function option:SetState(state)
		library.flags[self.flag] = state
		self.state = state
		checkmarkHolder:TweenSize(option.state and UDim2.new(1, -8, 1, -8) or UDim2.new(0, 0, 1, -8), "Out", "Quad", 0.2, true)
		tweenService:Create(tickboxInner, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = state and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(20, 20, 20)}):Play()
		if state then
			tweenService:Create(tickboxOutline, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
		else
			if inContact then
				tweenService:Create(tickboxOutline, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(140, 140, 140)}):Play()
			else
				tweenService:Create(tickboxOutline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			end
		end
		self.callback(state)
	end

	if option.state then
		delay(1, function() option.callback(true) end)
	end
	
	setmetatable(option, {__newindex = function(t, i, v)
		if i == "Text" then
			main.Text = " " .. tostring(v)
		end
	end})
end

function createButton(option, parent)
	local main = library:Create("TextLabel", {
		ZIndex = 2,
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 34),
		BackgroundTransparency = 1,
		Text = " " .. option.text,
		TextSize = 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Parent = parent.content
	})
	
	local round = library:Create("ImageLabel", {
		AnchorPoint = Vector2.new(0.5, 0.5),
		Position = UDim2.new(0.5, 0, 0.5, 0),
		Size = UDim2.new(1, -12, 1, -10),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(40, 40, 40),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local inContact
	local clicking
	main.InputBegan:connect(function(input)
		if input.UserInputType == ui then
			library.flags[option.flag] = true
			clicking = true
			tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			option.callback()
		elseif input.UserInputType == Enum.UserInputType.Touch then
			library.flags[option.flag] = true
			clicking = true
			tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			option.callback()
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			tweenService:Create(round, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
		end
	end)
	
	main.InputEnded:connect(function(input)
		if input.UserInputType == ui then
			clicking = false
			if inContact then
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			else
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(40, 40, 40)}):Play()
			end
		elseif input.UserInputType == Enum.UserInputType.Touch then
			clicking = false
			if inContact then
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			else
				tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(40, 40, 40)}):Play()
			end
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = false
			if not clicking then
				tweenService:Create(round, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(40, 40, 40)}):Play()
			end
		end
	end)
end

local function createBind(option, parent)
	local binding
	local holding
	local loop
	local text = string.match(option.key, "Mouse") and string.sub(option.key, 1, 5) .. string.sub(option.key, 12, 13) or option.key

	local main = library:Create("TextLabel", {
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 33),
		BackgroundTransparency = 1,
		Text = " " .. option.text,
		TextSize = 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		TextXAlignment = Enum.TextXAlignment.Left,
		Parent = parent.content
	})
	
	local round = library:Create("ImageLabel", {
		Position = UDim2.new(1, -6, 0, 4),
		Size = UDim2.new(0, -textService:GetTextSize(text, 16, Enum.Font.GothamBold, Vector2.new(9e9, 9e9)).X - 16, 1, -10),
		SizeConstraint = Enum.SizeConstraint.RelativeYY,
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(40, 40, 40),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local bindinput = library:Create("TextLabel", {
		Size = UDim2.new(1, 0, 1, 0),
		BackgroundTransparency = 1,
		Text = text,
		TextSize = 16,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		Parent = round
	})
	
	local inContact
	main.InputBegan:connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			if not binding then
				tweenService:Create(round, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			end
		end
	end)
	 
	main.InputEnded:connect(function(input)
		if input.UserInputType == ui then
			binding = true
			bindinput.Text = "..."
			tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
		elseif input.UserInputType == Enum.UserInputType.Touch then
			binding = true
			bindinput.Text = "..."
			tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = false
			if not binding then
				tweenService:Create(round, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(40, 40, 40)}):Play()
			end
		end
	end)
	
	inputService.InputBegan:connect(function(input)
		if inputService:GetFocusedTextBox() then return end
		if (input.KeyCode.Name == option.key or input.UserInputType.Name == option.key) and not binding then
			if option.hold then
				loop = runService.Heartbeat:connect(function()
					if binding then
						option.callback(true)
						loop:Disconnect()
						loop = nil
					else
						option.callback()
					end
				end)
			else
				option.callback()
			end
		elseif binding then
			local key
			pcall(function()
				if not keyCheck(input.KeyCode, blacklistedKeys) then
					key = input.KeyCode
				end
			end)
			pcall(function()
				if keyCheck(input.UserInputType, whitelistedMouseinputs) and not key then
					key = input.UserInputType
				end
			end)
			key = key or option.key
			option:SetKey(key)
		end
	end)
	
	inputService.InputEnded:connect(function(input)
		if input.KeyCode.Name == option.key or input.UserInputType.Name == option.key or input.UserInputType.Name == "MouseMovement" then
			if loop then
				loop:Disconnect()
				loop = nil
				option.callback(true)
			end
		end
	end)
	
	function option:SetKey(key)
		binding = false
		if loop then
			loop:Disconnect()
			loop = nil
		end
		self.key = key or self.key
		self.key = self.key.Name or self.key
		library.flags[self.flag] = self.key
		if string.match(self.key, "Mouse") then
			bindinput.Text = string.sub(self.key, 1, 5) .. string.sub(self.key, 12, 13)
		else
			bindinput.Text = self.key
		end
		tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = inContact and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(40, 40, 40)}):Play()
		round.Size = UDim2.new(0, -textService:GetTextSize(bindinput.Text, 15, Enum.Font.GothamBold, Vector2.new(9e9, 9e9)).X - 16, 1, -10)	
	end
end

local function createSlider(option, parent)
	local main = library:Create("Frame", {
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 50),
		BackgroundTransparency = 1,
		Parent = parent.content
	})
	
	local title = library:Create("TextLabel", {
		Position = UDim2.new(0, 0, 0, 4),
		Size = UDim2.new(1, 0, 0, 20),
		BackgroundTransparency = 1,
		Text = " " .. option.text,
		TextSize = 17,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		TextXAlignment = Enum.TextXAlignment.Left,
		Parent = main
	})
	
	local slider = library:Create("ImageLabel", {
		Position = UDim2.new(0, 10, 0, 34),
		Size = UDim2.new(1, -20, 0, 5),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(30, 30, 30),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local fill = library:Create("ImageLabel", {
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(60, 60, 60),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = slider
	})
	
	local circle = library:Create("ImageLabel", {
		AnchorPoint = Vector2.new(0.5, 0.5),
		Position = UDim2.new((option.value - option.min) / (option.max - option.min), 0, 0.5, 0),
		SizeConstraint = Enum.SizeConstraint.RelativeYY,
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(60, 60, 60),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 1,
		Parent = slider
	})
	
	local valueRound = library:Create("ImageLabel", {
		Position = UDim2.new(1, -6, 0, 4),
		Size = UDim2.new(0, -60, 0, 18),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(40, 40, 40),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local inputvalue = library:Create("TextBox", {
		Size = UDim2.new(1, 0, 1, 0),
		BackgroundTransparency = 1,
		Text = option.value,
		TextColor3 = Color3.fromRGB(235, 235, 235),
		TextSize = 15,
		TextWrapped = true,
		Font = Enum.Font.GothamBold,
		Parent = valueRound
	})
	
	if option.min >= 0 then
		fill.Size = UDim2.new((option.value - option.min) / (option.max - option.min), 0, 1, 0)
	else
		fill.Position = UDim2.new((0 - option.min) / (option.max - option.min), 0, 0, 0)
		fill.Size = UDim2.new(option.value / (option.max - option.min), 0, 1, 0)
	end
	
	local sliding
	local inContact
	main.InputBegan:connect(function(input)
		if input.UserInputType == ui then
			tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(3.5, 0, 3.5, 0), ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			sliding = true
			option:SetValue(option.min + ((input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X) * (option.max - option.min))
		elseif input.UserInputType == Enum.UserInputType.Touch then
			tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(3.5, 0, 3.5, 0), ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
			sliding = true
			option:SetValue(option.min + ((input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X) * (option.max - option.min))
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			if not sliding then
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(2.8, 0, 2.8, 0), ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			end
		end
	end)
	
	inputService.InputChanged:connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement and sliding then
			option:SetValue(option.min + ((input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X) * (option.max - option.min))
		end
	end)

	main.InputEnded:connect(function(input)
		if input.UserInputType == ui then
			sliding = false
			if inContact then
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(2.8, 0, 2.8, 0), ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			else
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, 0, 0, 0), ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			end
		elseif input.UserInputType == Enum.UserInputType.Touch then
			sliding = false
			if inContact then
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(2.8, 0, 2.8, 0), ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			else
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, 0, 0, 0), ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			end
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = false
			inputvalue:ReleaseFocus()
			if not sliding then
				tweenService:Create(fill, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
				tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, 0, 0, 0), ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			end
		end
	end)

	inputvalue.FocusLost:connect(function()
		tweenService:Create(circle, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, 0, 0, 0), ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
		option:SetValue(tonumber(inputvalue.Text) or option.value)
	end)

	function option:SetValue(value)
		value = round(value, option.float)
		value = math.clamp(value, self.min, self.max)
		circle:TweenPosition(UDim2.new((value - self.min) / (self.max - self.min), 0, 0.5, 0), "Out", "Quad", 0.1, true)
		if self.min >= 0 then
			fill:TweenSize(UDim2.new((value - self.min) / (self.max - self.min), 0, 1, 0), "Out", "Quad", 0.1, true)
		else
			fill:TweenPosition(UDim2.new((0 - self.min) / (self.max - self.min), 0, 0, 0), "Out", "Quad", 0.1, true)
			fill:TweenSize(UDim2.new(value / (self.max - self.min), 0, 1, 0), "Out", "Quad", 0.1, true)
		end
		library.flags[self.flag] = value
		self.value = value
		inputvalue.Text = value
		self.callback(value)
	end
end

local function createList(option, parent, holder)
    local valueCount = 0
    option.itemCount = 0
    
    -- Tạo frame chính
    local main = library:Create("Frame", {
        LayoutOrder = option.position,
        Size = UDim2.new(1, 0, 0, 52),
        BackgroundTransparency = 1,
        Parent = parent.content
    })
    
    local round = library:Create("ImageLabel", {
        Position = UDim2.new(0, 6, 0, 4),
        Size = UDim2.new(1, -12, 1, -8),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageColor3 = Color3.fromRGB(40, 40, 40),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = main
    })
    
    local title = library:Create("TextLabel", {
        Position = UDim2.new(0, 12, 0, 6),
        Size = UDim2.new(1, -24, 0, 16),
        BackgroundTransparency = 1,
        Text = option.text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(140, 140, 140),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = main
    })
    
    local listvalue = library:Create("TextLabel", {
        Position = UDim2.new(0, 12, 0, 22),
        Size = UDim2.new(1, -24, 0, 22),
        BackgroundTransparency = 1,
        Text = option.multiSelect and (option.selectedValues[1] or "...") or option.value,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Top,
        Parent = main
    })
    
    -- Hiển thị số lượng item đã chọn ở chế độ multi-select
    local selectionCount = nil
    if option.multiSelect then
        selectionCount = library:Create("TextLabel", {
            AnchorPoint = Vector2.new(1, 0),
            Position = UDim2.new(1, -12, 0, 22),
            Size = UDim2.new(0, 40, 0, 22),
            BackgroundTransparency = 1,
            Text = tostring(#option.selectedValues),
            TextSize = 16,
            Font = Enum.Font.GothamBold,
            TextColor3 = Color3.fromRGB(100, 200, 255),
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = main
        })
    end
    
    library:Create("ImageLabel", {
        Position = UDim2.new(1, -16, 0, 20),
        Size = UDim2.new(-1, 20, 1, -20),
        SizeConstraint = Enum.SizeConstraint.RelativeYY,
        Rotation = 90,
        BackgroundTransparency = 1,
        Image = "rbxassetid://4918373417",
        ImageColor3 = Color3.fromRGB(140, 140, 140),
        ScaleType = Enum.ScaleType.Fit,
        Parent = round
    })
    
    -- Tạo popup holder
    option.mainHolder = library:Create("ImageButton", {
        ZIndex = 3,
        Size = UDim2.new(0, 240, 0, 52),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(30, 30, 30),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Visible = false,
        Parent = library.base
    })
    
    -- Thanh tìm kiếm (nếu được kích hoạt)
    if option.searchable then
        local searchBox = library:Create("TextBox", {
            Position = UDim2.new(0, 8, 0, 8),
            Size = UDim2.new(1, -16, 0, 30),
            BackgroundColor3 = Color3.fromRGB(20, 20, 20),
            BorderSizePixel = 0,
            PlaceholderText = "Search...",
            PlaceholderColor3 = Color3.fromRGB(120, 120, 120),
            TextColor3 = Color3.fromRGB(255, 255, 255),
            ClearTextOnFocus = false,
            Parent = option.mainHolder
        })
    end
    
    -- Khu vực cuộn
    local content = library:Create("ScrollingFrame", {
        ZIndex = 3,
        Position = UDim2.new(0, 0, 0, option.searchable and 40 or 8),
        Size = UDim2.new(1, 0, 1, option.searchable and -48 or -16),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 4,
        ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80),
        ScrollingDirection = Enum.ScrollingDirection.Y,
        Parent = option.mainHolder
    })
    option.content = content
    
    library:Create("UIPadding", {
        PaddingTop = UDim.new(0, 6),
        PaddingBottom = UDim.new(0, 6),
        Parent = content
    })
    
    local layout = library:Create("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = content
    })
    
    -- Cập nhật kích thước tự động
    layout.Changed:connect(function()
        if option.mainHolder.Visible then
            local targetHeight = math.min(layout.AbsoluteContentSize.Y + 12, option.maxVisibleItems * option.itemHeight)
            option.mainHolder:TweenSize(UDim2.new(0, 240, 0, targetHeight + (option.searchable and 40 or 16)), "Out", "Quad", 0.2)
            content.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        end
    end)
    
    -- Biến trạng thái
    local inContact = false
    local hovering = false
    
    -- Sự kiện hover trên nút chính
    round.InputBegan:connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            hovering = true
            inContact = true
            if not option.open then
                tweenService:Create(round, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(70, 70, 70)}):Play()
            end
        end
    end)
    
    round.InputChanged:connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            -- Xử lý di chuyển chuột
        end
    end)
    
    round.InputEnded:connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            hovering = false
            inContact = false
            if not option.open then
                tweenService:Create(round, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(40, 40, 40)}):Play()
            end
        end
    end)
    
    -- Sự kiện click để mở/đóng dropdown
    round.MouseButton1Click:connect(function()
        if library.activePopup and library.activePopup ~= option then
            library.activePopup:Close()
        end
        
        local position = main.AbsolutePosition
        option.mainHolder.Position = UDim2.new(0, position.X - 5, 0, position.Y - 10)
        option.open = not option.open
        option.mainHolder.Visible = option.open
        
        if option.open then
            library.activePopup = option
            content.ScrollBarThickness = 6
            
            -- Tính toán kích thước popup
            local itemCount = math.min(#option.values, option.maxVisibleItems)
            local popupHeight = itemCount * option.itemHeight + (option.searchable and 40 or 16)
            
            -- Hiệu ứng mở
            tweenService:Create(option.mainHolder, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                ImageTransparency = 0,
                Size = UDim2.new(0, 240, 0, popupHeight),
                Position = UDim2.new(0, position.X - 5, 0, position.Y - 4)
            }):Play()
            
            -- Di chuyển mượt mà
            tweenService:Create(option.mainHolder, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                Position = UDim2.new(0, position.X - 5, 0, position.Y + 1)
            }):Play()
            
            -- Hiển thị các item
            for _, child in ipairs(content:GetChildren()) do
                if child:IsA("TextLabel") or child:IsA("ImageButton") then
                    tweenService:Create(child, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                        BackgroundTransparency = 0,
                        TextTransparency = 0,
                        ImageTransparency = 0
                    }):Play()
                end
            end
        else
            option:Close()
        end
    end)
    
    -- Sự kiện nhấn phím ESC để đóng dropdown
    inputService.InputBegan:connect(function(input)
        if input.KeyCode == Enum.KeyCode.Escape and option.open then
            option:Close()
        end
    end)
    
    -- Hàm tạo item mới với các tính năng nâng cao
    function option:AddValue(value)
        option.itemCount = option.itemCount + 1
        local stringValue = tostring(value)
        
        -- Tạo frame cho item
        local itemFrame = library:Create("ImageButton", {
            Name = "ListItem_" .. stringValue:gsub("%W", ""),
            ZIndex = 3,
            Size = UDim2.new(1, 0, 0, option.itemHeight - 4),
            Position = UDim2.new(0, 4, 0, (option.itemCount - 1) * option.itemHeight + 2),
            BackgroundColor3 = Color3.fromRGB(30, 30, 30),
            BorderSizePixel = 0,
            AutoButtonColor = false,
            ClipsDescendants = true,
            Parent = content
        })
        
        -- Hiệu ứng hover
        local itemHoverEffect = library:Create("Frame", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundColor3 = Color3.fromRGB(60, 60, 60),
            BackgroundTransparency = 1,
            Parent = itemFrame
        })
        
        -- Label hiển thị giá trị
        local itemLabel = library:Create("TextLabel", {
            Size = UDim2.new(1, -24, 1, 0),
            BackgroundTransparency = 1,
            Text = stringValue,
            TextSize = 14,
            Font = Enum.Font.GothamBold,
            TextColor3 = Color3.fromRGB(255, 255, 255),
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.Clip,
            Parent = itemFrame
        })
        
        -- Dấu check cho chế độ multi-select
        local checkmark = nil
        if option.multiSelect then
            checkmark = library:Create("ImageLabel", {
                Name = "Checkmark",
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, -8, 0.5, 0),
                Size = UDim2.new(0, 18, 0, 18),
                BackgroundTransparency = 1,
                Image = "rbxassetid://4919148038",
                ImageTransparency = 1,
                ImageColor3 = Color3.fromRGB(255, 255, 255),
                Parent = itemFrame
            })
            
            -- Cập nhật trạng thái checkmark nếu item đã được chọn
            if table.find(option.selectedValues, stringValue) then
                checkmark.ImageTransparency = 0
                itemFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
        end
        
        -- Sự kiện hover
        itemFrame.MouseEnter:connect(function()
            tweenService:Create(itemHoverEffect, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                BackgroundTransparency = 0.7
            }):Play()
        end)
        
        itemFrame.MouseLeave:connect(function()
            tweenService:Create(itemHoverEffect, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                BackgroundTransparency = 1
            }):Play()
        end)
        
        -- Sự kiện click vào item
        itemFrame.MouseButton1Click:connect(function()
            if option.multiSelect then
                local isSelected = table.find(option.selectedValues, stringValue)
                
                if isSelected then
                    option:UnselectItem(stringValue)
                    -- Cập nhật UI
                    itemFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                    checkmark.ImageTransparency = 1
                else
                    local success, msg = option:SelectItem(stringValue)
                    if success then
                        -- Cập nhật UI
                        itemFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                        checkmark.ImageTransparency = 0
                    end
                end
                
                -- Cập nhật số lượng item đã chọn
                if selectionCount then
                    selectionCount.Text = tostring(#option.selectedValues)
                end
            else
                option:SetValue(stringValue)
                option:Close()
            end
        end)
        
        -- Cập nhật giao diện ban đầu
        if not option.multiSelect and option.value == stringValue then
            itemFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        end
        
        return itemFrame
    end
    
    -- Hàm đóng dropdown
    function option:Close()
        library.activePopup = nil
        self.open = false
        content.ScrollBarThickness = 0
        
        local position = main.AbsolutePosition
        
        -- Hoạt ảnh đóng
        tweenService:Create(round, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            ImageColor3 = Color3.fromRGB(40, 40, 40)
        }):Play()
        
        tweenService:Create(self.mainHolder, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            ImageTransparency = 1,
            Position = UDim2.new(0, position.X - 5, 0, position.Y - 10)
        }):Play()
        
        for _, child in ipairs(self.content:GetChildren()) do
            if child:IsA("ImageButton") or child:IsA("TextLabel") then
                tweenService:Create(child, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                    BackgroundTransparency = 1,
                    TextTransparency = 1,
                    ImageTransparency = 1
                }):Play()
            end
        end
        
        -- Ẩn sau khi hoàn tất hoạt ảnh
        delay(0.3, function()
            if not self.open then
                self.mainHolder.Visible = false
            end
        end)
    end
    
    -- Khởi tạo các item ban đầu
    if #option.values > 0 then
        for _, value in ipairs(option.values) do
            option:AddValue(value)
        end
    end
    
    -- Cập nhật UI ban đầu cho chế độ multi-select
    if option.multiSelect and selectionCount then
        selectionCount.Text = tostring(#option.selectedValues)
    end
    
    return option
end

local function createBox(option, parent)
	local main = library:Create("Frame", {
		LayoutOrder = option.position,
		Size = UDim2.new(1, 0, 0, 52),
		BackgroundTransparency = 1,
		Parent = parent.content
	})
	
	local outline = library:Create("ImageLabel", {
		Position = UDim2.new(0, 6, 0, 4),
		Size = UDim2.new(1, -12, 1, -10),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(60, 60, 60),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.02,
		Parent = main
	})
	
	local round = library:Create("ImageLabel", {
		Position = UDim2.new(0, 8, 0, 6),
		Size = UDim2.new(1, -16, 1, -14),
		BackgroundTransparency = 1,
		Image = "rbxassetid://3570695787",
		ImageColor3 = Color3.fromRGB(20, 20, 20),
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(100, 100, 100, 100),
		SliceScale = 0.01,
		Parent = main
	})
	
	local title = library:Create("TextLabel", {
		Position = UDim2.new(0, 12, 0, 8),
		Size = UDim2.new(1, -24, 0, 14),
		BackgroundTransparency = 1,
		Text = option.text,
		TextSize = 14,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(100, 100, 100),
		TextXAlignment = Enum.TextXAlignment.Left,
		Parent = main
	})
	
	local inputvalue = library:Create("TextBox", {
		Position = UDim2.new(0, 12, 0, 20),
		Size = UDim2.new(1, -24, 0, 24),
		BackgroundTransparency = 1,
		Text = option.value,
		TextSize = 18,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(255, 255, 255),
		TextXAlignment = Enum.TextXAlignment.Left,
		TextWrapped = true,
		Parent = main
	})
	
	local inContact
	local focused
	main.InputBegan:connect(function(input)
		if input.UserInputType == ui then
			if not focused then inputvalue:CaptureFocus() end
		elseif input.UserInputType == Enum.UserInputType.Touch then
			if not focused then inputvalue:CaptureFocus() end
		end
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = true
			if not focused then
				tweenService:Create(outline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
			end
		end
	end)
	
	main.InputEnded:connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			inContact = false
			if not focused then
				tweenService:Create(outline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
			end
		end
	end)
	
	inputvalue.Focused:connect(function()
		focused = true
		tweenService:Create(outline, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(255, 255, 255)}):Play()
	end)
	
	inputvalue.FocusLost:connect(function(enter)
		focused = false
		tweenService:Create(outline, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(60, 60, 60)}):Play()
		option:SetValue(inputvalue.Text, enter)
	end)
	
	function option:SetValue(value, enter)
		library.flags[self.flag] = tostring(value)
		self.value = tostring(value)
		inputvalue.Text = self.value
		self.callback(value, enter)
	end
end

local function createColorPickerWindow(option)
    -- Kiểm tra và xóa mainHolder cũ nếu tồn tại
    if option.mainHolder then
        option.mainHolder:Destroy()
    end
    
    -- Tạo cửa sổ chính cho color picker
    option.mainHolder = library:Create("ImageButton", {
        ZIndex = 3,
        Size = UDim2.new(0, 240, 0, 180),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(30, 30, 30),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Visible = false,
        Parent = library.base
    })
    
    -- Khởi tạo giá trị hue, saturation, value từ màu hiện tại
    local hue, sat, val
    pcall(function()
        hue, sat, val = Color3.toHSV(option.color)
    end)
    
    -- Xử lý các trường hợp đặc biệt
    hue = hue or 0
    hue = hue == 0 and 1 or hue -- Tránh chia cho 0
    
    sat = sat or 1
    sat = math.clamp(sat + 0.005, 0.005, 1) -- Thêm một chút offset và đảm bảo trong khoảng hợp lệ
    
    val = val or 1
    val = math.clamp(val - 0.005, 0, 0.995) -- Thêm một chút offset và đảm bảo trong khoảng hợp lệ
    
    -- Các biến trạng thái
    local editinghue = false
    local editingsatval = false
    local currentColor = option.color
    local previousColors = {[1] = option.color}
    local originalColor = option.color
    local rainbowEnabled = false
    local rainbowLoop
    
    -- Hàm cập nhật visual và màu sắc
    function option:updateVisuals(Color)
        if typeof(Color) ~= "Color3" then 
            Color = Color3.fromRGB(255, 255, 255)
        end
        
        currentColor = Color
        self.visualize2.ImageColor3 = Color
        
        -- Lấy HSV từ màu hiện tại
        local h, s, v
        pcall(function()
            h, s, v = Color3.toHSV(Color)
        end)
        
        h = h or 0
        h = h == 0 and 1 or h
        
        s = s or 1
        s = math.clamp(s, 0.005, 1)
        
        v = v or 1
        v = math.clamp(v, 0, 0.995)
        
        -- Cập nhật các thành phần visual
        self.satval.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
        self.hueSlider.Position = UDim2.new(1 - h, 0, 0, 0)
        self.satvalSlider.Position = UDim2.new(s, 0, 1 - v, 0)
    end
    
    -- Tạo các thành phần UI
    
    -- Thanh chọn Hue
    option.hue = library:Create("ImageLabel", {
        ZIndex = 3,
        AnchorPoint = Vector2.new(0, 1),
        Position = UDim2.new(0, 8, 1, -8),
        Size = UDim2.new(1, -100, 0, 22),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    -- Gradient cho thanh Hue
    local Gradient = library:Create("UIGradient", {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
            ColorSequenceKeypoint.new(0.157, Color3.fromRGB(255, 0, 255)),
            ColorSequenceKeypoint.new(0.323, Color3.fromRGB(0, 0, 255)),
            ColorSequenceKeypoint.new(0.488, Color3.fromRGB(0, 255, 255)),
            ColorSequenceKeypoint.new(0.66, Color3.fromRGB(0, 255, 0)),
            ColorSequenceKeypoint.new(0.817, Color3.fromRGB(255, 255, 0)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0)),
        }),
        Parent = option.hue
    })
    
    -- Thanh trượt Hue
    option.hueSlider = library:Create("Frame", {
        ZIndex = 3,
        Position = UDim2.new(1 - hue, 0, 0, 0),
        Size = UDim2.new(0, 2, 1, 0),
        BackgroundTransparency = 1,
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        BorderColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.hue
    })
    
    -- Vùng chọn Saturation/Value
    option.satval = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(0, 8, 0, 8),
        Size = UDim2.new(1, -100, 1, -42),
        BackgroundTransparency = 1,
        BackgroundColor3 = Color3.fromHSV(hue, 1, 1),
        BorderSizePixel = 0,
        Image = "rbxassetid://4155801252",
        ImageTransparency = 1,
        ClipsDescendants = true,
        Parent = option.mainHolder
    })
    
    -- Thanh trượt Saturation/Value
    option.satvalSlider = library:Create("Frame", {
        ZIndex = 3,
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(sat, 0, 1 - val, 0),
        Size = UDim2.new(0, 4, 0, 4),
        Rotation = 45,
        BackgroundTransparency = 1,
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.satval
    })
    
    -- Hiển thị màu hiện tại
    option.visualize2 = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(1, -8, 0, 8),
        Size = UDim2.new(0, -80, 0, 80),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageColor3 = currentColor,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    -- Nút Reset
    option.resetColor = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(1, -8, 0, 92),
        Size = UDim2.new(0, -80, 0, 18),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(20, 20, 20),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    option.resetText = library:Create("TextLabel", {
        ZIndex = 3,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "Reset",
        TextTransparency = 1,
        Font = Enum.Font.Code,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.resetColor
    })
    
    -- Nút Undo
    option.undoColor = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(1, -8, 0, 112),
        Size = UDim2.new(0, -80, 0, 18),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(20, 20, 20),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    option.undoText = library:Create("TextLabel", {
        ZIndex = 3,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "Undo",
        TextTransparency = 1,
        Font = Enum.Font.Code,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.undoColor
    })
    
    -- Nút Set
    option.setColor = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(1, -8, 0, 132),
        Size = UDim2.new(0, -80, 0, 18),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(20, 20, 20),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    option.setText = library:Create("TextLabel", {
        ZIndex = 3,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "Set",
        TextTransparency = 1,
        Font = Enum.Font.Code,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.setColor
    })
    
    -- Nút Rainbow
    option.rainbow = library:Create("ImageLabel", {
        ZIndex = 3,
        Position = UDim2.new(1, -8, 0, 152),
        Size = UDim2.new(0, -80, 0, 18),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageTransparency = 1,
        ImageColor3 = Color3.fromRGB(20, 20, 20),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.mainHolder
    })
    
    option.rainbowText = library:Create("TextLabel", {
        ZIndex = 3,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "Rainbow",
        TextTransparency = 1,
        Font = Enum.Font.Code,
        TextSize = 15,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Parent = option.rainbow
    })
    
    -- Event handlers
    
    -- Xử lý thanh Hue
    option.hue.InputBegan:connect(function(Input)
        if Input.UserInputType == ui then
            editinghue = true
            local X = (option.hue.AbsolutePosition.X + option.hue.AbsoluteSize.X) - option.hue.AbsolutePosition.X
            local posX = (Input.Position.X - option.hue.AbsolutePosition.X) / X
            posX = math.clamp(posX, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(1 - posX, sat, val))
        elseif Input.UserInputType == Enum.UserInputType.Touch then
            editinghue = true
            local X = (option.hue.AbsolutePosition.X + option.hue.AbsoluteSize.X) - option.hue.AbsolutePosition.X
            local posX = (Input.Position.X - option.hue.AbsolutePosition.X) / X
            posX = math.clamp(posX, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(1 - posX, sat, val))
        end
    end)
    
    option.hue.InputEnded:connect(function(Input)
        if Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch then
            editinghue = false
        end
    end)
    
    -- Xử lý vùng Saturation/Value
    option.satval.InputBegan:connect(function(Input)
        if Input.UserInputType == ui then
            editingsatval = true
            local X = (option.satval.AbsolutePosition.X + option.satval.AbsoluteSize.X) - option.satval.AbsolutePosition.X
            local Y = (option.satval.AbsolutePosition.Y + option.satval.AbsoluteSize.Y) - option.satval.AbsolutePosition.Y
            local posX = (Input.Position.X - option.satval.AbsolutePosition.X) / X
            local posY = (Input.Position.Y - option.satval.AbsolutePosition.Y) / Y
            posX = math.clamp(posX, 0.005, 1)
            posY = math.clamp(posY, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(hue, posX, 1 - posY))
        elseif Input.UserInputType == Enum.UserInputType.Touch then
            editingsatval = true
            local X = (option.satval.AbsolutePosition.X + option.satval.AbsoluteSize.X) - option.satval.AbsolutePosition.X
            local Y = (option.satval.AbsolutePosition.Y + option.satval.AbsoluteSize.Y) - option.satval.AbsolutePosition.Y
            local posX = (Input.Position.X - option.satval.AbsolutePosition.X) / X
            local posY = (Input.Position.Y - option.satval.AbsolutePosition.Y) / Y
            posX = math.clamp(posX, 0.005, 1)
            posY = math.clamp(posY, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(hue, posX, 1 - posY))
        end
    end)
    
    option.satval.InputEnded:connect(function(Input)
        if Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch then
            editingsatval = false
        end
    end)
    
    -- Xử lý di chuyển chuột
    inputService.InputChanged:connect(function(Input)
        if editinghue and (Input.UserInputType == Enum.UserInputType.MouseMovement or Input.UserInputType == Enum.UserInputType.Touch) then
            local X = (option.hue.AbsolutePosition.X + option.hue.AbsoluteSize.X) - option.hue.AbsolutePosition.X
            local posX = (Input.Position.X - option.hue.AbsolutePosition.X) / X
            posX = math.clamp(posX, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(1 - posX, sat, val))
        elseif editingsatval and (Input.UserInputType == Enum.UserInputType.MouseMovement or Input.UserInputType == Enum.UserInputType.Touch) then
            local X = (option.satval.AbsolutePosition.X + option.satval.AbsoluteSize.X) - option.satval.AbsolutePosition.X
            local Y = (option.satval.AbsolutePosition.Y + option.satval.AbsoluteSize.Y) - option.satval.AbsolutePosition.Y
            local posX = (Input.Position.X - option.satval.AbsolutePosition.X) / X
            local posY = (Input.Position.Y - option.satval.AbsolutePosition.Y) / Y
            posX = math.clamp(posX, 0.005, 1)
            posY = math.clamp(posY, 0, 0.995)
            option:updateVisuals(Color3.fromHSV(hue, posX, 1 - posY))
        end
    end)
    
    -- Xử lý nút Reset
    option.resetColor.InputBegan:connect(function(Input)
        if (Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch) and not rainbowEnabled then
            previousColors = {originalColor}
            option:SetColor(originalColor)
        end
    end)
    
    -- Xử lý nút Undo
    option.undoColor.InputBegan:connect(function(Input)
        if (Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch) and not rainbowEnabled then
            local Num = #previousColors == 1 and 0 or 1
            option:SetColor(previousColors[#previousColors - Num])
            if #previousColors ~= 1 then
                table.remove(previousColors, #previousColors)
            end
        end
    end)
    
    -- Xử lý nút Set
    option.setColor.InputBegan:connect(function(Input)
        if (Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch) and not rainbowEnabled then
            table.insert(previousColors, currentColor)
            option:SetColor(currentColor)
        end
    end)
    
    -- Xử lý nút Rainbow
    option.rainbow.InputBegan:connect(function(Input)
        if Input.UserInputType == ui or Input.UserInputType == Enum.UserInputType.Touch then
            rainbowEnabled = not rainbowEnabled
            if rainbowEnabled then
                rainbowLoop = runService.Heartbeat:connect(function()
                    option:SetColor(chromaColor)
                    option.rainbowText.TextColor3 = chromaColor
                end)
            else
                if rainbowLoop then
                    rainbowLoop:Disconnect()
                end
                option:SetColor(previousColors[#previousColors])
                option.rainbowText.TextColor3 = Color3.fromRGB(255, 255, 255)
            end
        end
    end)
    
    -- Xử lý hover effect cho các nút
    local function setupHoverEffect(button)
        button.InputBegan:connect(function(Input)
            if Input.UserInputType == Enum.UserInputType.MouseMovement or Input.UserInputType == Enum.UserInputType.Touch then
                tweenService:Create(button, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(10, 10, 10)}):Play()
            end
        end)
        
        button.InputEnded:connect(function(Input)
            if Input.UserInputType == Enum.UserInputType.MouseMovement or Input.UserInputType == Enum.UserInputType.Touch then
                tweenService:Create(button, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(20, 20, 20)}):Play()
            end
        end)
    end
    
    setupHoverEffect(option.resetColor)
    setupHoverEffect(option.undoColor)
    setupHoverEffect(option.setColor)
    setupHoverEffect(option.rainbow)
    
    -- Khởi tạo visual ban đầu
    option:updateVisuals(option.color)
    
    return option
end

local function createColor(option, parent, holder)
    option.main = library:Create("TextLabel", {
        LayoutOrder = option.position,
        Size = UDim2.new(1, 0, 0, 31),
        BackgroundTransparency = 1,
        Text = " " .. option.text,
        TextSize = 17,
        Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = parent.content
    })
    
    local colorBoxOutline = library:Create("ImageLabel", {
        Position = UDim2.new(1, -6, 0, 4),
        Size = UDim2.new(-1, 10, 1, -10),
        SizeConstraint = Enum.SizeConstraint.RelativeYY,
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageColor3 = Color3.fromRGB(100, 100, 100),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = option.main
    })
    
    option.visualize = library:Create("ImageLabel", {
        Position = UDim2.new(0, 2, 0, 2),
        Size = UDim2.new(1, -4, 1, -4),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageColor3 = option.color,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.02,
        Parent = colorBoxOutline
    })
    
    local inContact
    option.main.InputBegan:connect(function(input)
        if input.UserInputType == ui then
            -- Đảm bảo window đã được tạo trước khi sử dụng
            if not option.mainHolder then 
                createColorPickerWindow(option)
                option:updateVisuals(option.color) -- Cập nhật visual ban đầu
            end
            
            if library.activePopup and library.activePopup ~= option then
                library.activePopup:Close()
            end
            
            local position = option.main.AbsolutePosition
            option.mainHolder.Position = UDim2.new(0, position.X - 5, 0, position.Y - 10)
            option.open = true
            option.mainHolder.Visible = true
            library.activePopup = option
            
            tweenService:Create(option.mainHolder, TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {ImageTransparency = 0, Position = UDim2.new(0, position.X - 5, 0, position.Y - 4)}):Play()
            tweenService:Create(option.mainHolder, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 0, false, 0.1), {Position = UDim2.new(0, position.X - 5, 0, position.Y + 1)}):Play()
            tweenService:Create(option.satval, TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {BackgroundTransparency = 0}):Play()
            
            for _, object in next, option.mainHolder:GetDescendants() do
                if object:IsA("TextLabel") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 0}):Play()
                elseif object:IsA("ImageLabel") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageTransparency = 0}):Play()
                elseif object:IsA("Frame") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 0}):Play()
                end
            end
        elseif input.UserInputType == Enum.UserInputType.Touch then
            if not option.mainHolder then 
                createColorPickerWindow(option)
                option:updateVisuals(option.color)
            end
            
            if library.activePopup and library.activePopup ~= option then
                library.activePopup:Close()
            end
            
            local position = option.main.AbsolutePosition
            option.mainHolder.Position = UDim2.new(0, position.X - 5, 0, position.Y - 10)
            option.open = true
            option.mainHolder.Visible = true
            library.activePopup = option
            
            tweenService:Create(option.mainHolder, TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {ImageTransparency = 0, Position = UDim2.new(0, position.X - 5, 0, position.Y - 4)}):Play()
            tweenService:Create(option.mainHolder, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 0, false, 0.1), {Position = UDim2.new(0, position.X - 5, 0, position.Y + 1)}):Play()
            tweenService:Create(option.satval, TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {BackgroundTransparency = 0}):Play()
            
            for _, object in next, option.mainHolder:GetDescendants() do
                if object:IsA("TextLabel") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 0}):Play()
                elseif object:IsA("ImageLabel") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageTransparency = 0}):Play()
                elseif object:IsA("Frame") then
                    tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 0}):Play()
                end
            end
        end
        
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            inContact = true
            if not option.open then
                tweenService:Create(colorBoxOutline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(140, 140, 140)}):Play()
            end
        end
    end)
    
    option.main.InputEnded:connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            inContact = false
            if not option.open and not dragging then
                tweenService:Create(colorBoxOutline, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = Color3.fromRGB(100, 100, 100)}):Play()
            end
        end
    end)
    
    function option:SetColor(newColor)
        -- Đảm bảo newColor là Color3 hợp lệ
        if typeof(newColor) ~= "Color3" then return end
        
        if self.mainHolder then
            self:updateVisuals(newColor)
        end
        self.visualize.ImageColor3 = newColor
        library.flags[self.flag] = newColor
        self.color = newColor
        self.callback(newColor)
    end
    
    function option:Close()
        library.activePopup = nil
        self.open = false
        
        if not self.mainHolder then return end
        
        local position = self.main.AbsolutePosition
        tweenService:Create(self.mainHolder, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageTransparency = 1, Position = UDim2.new(0, position.X - 5, 0, position.Y - 10)}):Play()
        tweenService:Create(self.satval, TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
        
        for _, object in next, self.mainHolder:GetDescendants() do
            if object:IsA("TextLabel") then
                tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {TextTransparency = 1}):Play()
            elseif object:IsA("ImageLabel") then
                tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageTransparency = 1}):Play()
            elseif object:IsA("Frame") then
                tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
            end
        end
        
        delay(0.3, function()
            if not self.open and self.mainHolder then
                self.mainHolder.Visible = false
            end
        end)
    end
    return option
end

local function loadOptions(option, holder)
	for _,newOption in next, option.options do
		if newOption.type == "label" then
			createLabel(newOption, option)
		elseif newOption.type == "toggle" then
			createToggle(newOption, option)
		elseif newOption.type == "button" then
			createButton(newOption, option)
		elseif newOption.type == "list" then
			createList(newOption, option, holder)
		elseif newOption.type == "box" then
			createBox(newOption, option)
		elseif newOption.type == "bind" then
			createBind(newOption, option)
		elseif newOption.type == "slider" then
			createSlider(newOption, option)
		elseif newOption.type == "color" then
			createColor(newOption, option, holder)
		elseif newOption.type == "folder" then
			newOption:init()
		end
	end
end

local function getFnctions(parent)
	function parent:AddLabel(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.type = "label"
		option.position = #self.options
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddToggle(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.state = typeof(option.state) == "boolean" and option.state or false
		option.callback = typeof(option.callback) == "function" and option.callback or function() end
		option.type = "toggle"
		option.position = #self.options
		option.flag = option.flag or option.text
		library.flags[option.flag] = option.state
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddButton(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.callback = typeof(option.callback) == "function" and option.callback or function() end
		option.type = "button"
		option.position = #self.options
		option.flag = option.flag or option.text
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddBind(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.key = (option.key and option.key.Name) or option.key or "F"
		option.hold = typeof(option.hold) == "boolean" and option.hold or false
		option.callback = typeof(option.callback) == "function" and option.callback or function() end
		option.type = "bind"
		option.position = #self.options
		option.flag = option.flag or option.text
		library.flags[option.flag] = option.key
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddSlider(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.min = typeof(option.min) == "number" and option.min or 0
		option.max = typeof(option.max) == "number" and option.max or 0
		option.dual = typeof(option.dual) == "boolean" and option.dual or false
		option.value = math.clamp(typeof(option.value) == "number" and option.value or option.min, option.min, option.max)
		option.value2 = typeof(option.value2) == "number" and option.value2 or option.max
		option.callback = typeof(option.callback) == "function" and option.callback or function() end
		option.float = typeof(option.value) == "number" and option.float or 1
		option.type = "slider"
		option.position = #self.options
		option.flag = option.flag or option.text
		library.flags[option.flag] = option.value
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddList(option)
    -- Validate và chuẩn hóa option table
    option = typeof(option) == "table" and option or {}
    
    -- Validation cơ bản
    option.text = tostring(option.text or "List")
    option.values = (typeof(option.values) == "table" and #option.values > 0) and option.values or {"Default"}
    
    -- Xử lý giá trị mặc định một cách thông minh hơn
    local defaultValue
    if option.value then
        defaultValue = tostring(option.value)
    elseif option.defaultIndex and type(option.defaultIndex) == "number" and option.defaultIndex >= 1 and option.defaultIndex <= #option.values then
        defaultValue = tostring(option.values[option.defaultIndex])
    else
        defaultValue = tostring(option.values[1])
    end
    
    -- Callback validation
    option.callback = typeof(option.callback) == "function" and option.callback or function() end
    option.onChange = typeof(option.onChange) == "function" and option.onChange or nil
    
    -- Cấu hình mở rộng
    option.multiSelect = typeof(option.multiSelect) == "boolean" and option.multiSelect or false
    option.maxSelections = option.multiSelect and (type(option.maxSelections) == "number" and option.maxSelections > 0 and option.maxSelections or nil) or nil
    option.allowCustomInput = typeof(option.allowCustomInput) == "boolean" and option.allowCustomInput or false
    option.searchable = typeof(option.searchable) == "boolean" and option.searchable or false
    option.itemHeight = type(option.itemHeight) == "number" and option.itemHeight > 0 and option.itemHeight or 40
    option.maxVisibleItems = type(option.maxVisibleItems) == "number" and option.maxVisibleItems > 0 and option.maxVisibleItems or 6
    
    -- Thiết lập trạng thái ban đầu
    option.open = false
    option.type = "list"
    option.position = #self.options
    option.flag = option.flag or option.text
    
    -- Xử lý giá trị ban đầu dựa trên chế độ multiSelect
    if option.multiSelect then
        option.selectedValues = {}
        if type(option.selectedValues) == "table" then
            -- Chuyển đổi giá trị ban đầu thành mảng hợp lệ
            for _, val in ipairs(option.selectedValues) do
                table.insert(option.selectedValues, tostring(val))
            end
        end
        library.flags[option.flag] = option.selectedValues
    else
        option.value = defaultValue
        library.flags[option.flag] = option.value
    end
    
    -- Thêm vào danh sách options
    table.insert(self.options, option)
    
    -- Phương thức mở rộng cho List API
    function option:AddItem(value)
        if typeof(value) ~= "string" and typeof(value) ~= "number" then
            return false, "Invalid item type. Must be string or number."
        end
        
        value = tostring(value)
        if table.find(self.values, value) then
            return false, "Item already exists"
        end
        
        table.insert(self.values, value)
        
        -- Nếu là item đầu tiên và không có giá trị được chọn
        if #self.values == 1 and not self.multiSelect and (not self.value or self.value == "")) then
            self:SetValue(value)
        end
        
        -- Cập nhật UI nếu list đang mở
        if self.mainHolder and self.mainHolder.Visible then
            self:RefreshItems()
        end
        
        return true
    end
    
    function option:RemoveItem(value)
        if typeof(value) ~= "string" and typeof(value) ~= "number" then
            return false, "Invalid item type. Must be string or number."
        end
        
        value = tostring(value)
        local index = table.find(self.values, value)
        
        if not index then
            return false, "Item not found"
        end
        
        table.remove(self.values, index)
        
        -- Xử lý nếu item bị xóa là giá trị đang được chọn
        if not self.multiSelect then
            if self.value == value then
                if #self.values > 0 then
                    self:SetValue(self.values[1])
                else
                    self:SetValue("")
                end
            end
        else
            -- Xóa khỏi danh sách đã chọn nếu tồn tại
            local selectedIndex = table.find(self.selectedValues, value)
            if selectedIndex then
                table.remove(self.selectedValues, selectedIndex)
                if self.onChange then
                    self.onChange(self.selectedValues)
                end
            end
        end
        
        -- Cập nhật UI nếu list đang mở
        if self.mainHolder and self.mainHolder.Visible then
            self:RefreshItems()
        end
        
        return true
    end
    
    function option:ClearItems()
        self.values = {}
        if not self.multiSelect then
            self:SetValue("")
        else
            self.selectedValues = {}
            if self.onChange then
                self.onChange(self.selectedValues)
            end
        end
        
        if self.mainHolder and self.mainHolder.Visible then
            self:RefreshItems()
        end
    end
    
    function option:RefreshItems()
        -- Xóa tất cả các item cũ
        for _, child in ipairs(self.content:GetChildren()) do
            if child.Name == "ListItem" then
                child:Destroy()
            end
        end
        
        -- Tạo lại các item mới
        self.valueCount = 0
        for _, value in ipairs(self.values) do
            self:AddValue(value)
        end
        
        -- Cập nhật kích thước popup
        local layout = self.content:FindFirstChildOfClass("UIListLayout")
        if layout then
            self.mainHolder.Size = UDim2.new(0, 240, 0, math.min(self.itemCount * self.itemHeight, self.maxVisibleItems * self.itemHeight) + 24)
            self.content.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        end
    end
    
    function option:HasItem(value)
        return table.find(self.values, tostring(value)) ~= nil
    end
    
    function option:GetItems()
        return table.clone(self.values)
    end
    
    function option:SetValue(value)
        if self.multiSelect then
            return false, "Cannot use SetValue with multiSelect enabled. Use SelectItem/UnselectItem instead."
        end
        
        local stringValue = tostring(value)
        
        -- Chỉ cập nhật nếu giá trị thay đổi
        if self.value ~= stringValue then
            if #self.values > 0 and not self:HasItem(value) then
                if self.allowCustomInput then
                    self:AddItem(stringValue)
                else
                    return false, "Value not found in list items"
                end
            end
            
            self.value = stringValue
            library.flags[self.flag] = self.value
            
            -- Cập nhật giao diện nếu tồn tại
            if self.listvalue then
                self.listvalue.Text = self.value
            end
            
            -- Gọi callbacks
            self.callback(self.value)
            if self.onChange then
                self.onChange(self.value)
            end
        end
        
        return true
    end
    
    function option:SelectItem(value)
        if not self.multiSelect then
            return false, "Cannot use SelectItem with multiSelect disabled. Use SetValue instead."
        end
        
        value = tostring(value)
        
        -- Kiểm tra nếu giá trị tồn tại trong danh sách
        if not self:HasItem(value) then
            if self.allowCustomInput then
                self:AddItem(value)
            else
                return false, "Value not found in list items"
            end
        end
        
        -- Kiểm tra nếu đã chọn giá trị này rồi
        if table.find(self.selectedValues, value) then
            return true  -- Đã chọn rồi
        end
        
        -- Kiểm tra giới hạn số lượng lựa chọn
        if self.maxSelections and #self.selectedValues >= self.maxSelections then
            return false, string.format("Maximum %d selections reached", self.maxSelections)
        end
        
        -- Thêm vào danh sách đã chọn
        table.insert(self.selectedValues, value)
        
        -- Cập nhật UI
        if self.mainHolder and self.mainHolder.Visible then
            local itemFrame = self.content:FindFirstChild("ListItem_" .. value)
            if itemFrame then
                local checkmark = itemFrame:FindFirstChild("Checkmark")
                if checkmark then
                    checkmark.ImageTransparency = 0
                end
                itemFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
        end
        
        library.flags[self.flag] = table.clone(self.selectedValues)
        
        -- Gọi callbacks
        self.callback(table.clone(self.selectedValues))
        if self.onChange then
            self.onChange(table.clone(self.selectedValues))
        end
        
        return true
    end
    
    function option:UnselectItem(value)
        if not self.multiSelect then
            return false, "Cannot use UnselectItem with multiSelect disabled."
        end
        
        value = tostring(value)
        local index = table.find(self.selectedValues, value)
        
        if not index then
            return false, "Item not selected"
        end
        
        table.remove(self.selectedValues, index)
        
        -- Cập nhật UI
        if self.mainHolder and self.mainHolder.Visible then
            local itemFrame = self.content:FindFirstChild("ListItem_" .. value)
            if itemFrame then
                local checkmark = itemFrame:FindFirstChild("Checkmark")
                if checkmark then
                    checkmark.ImageTransparency = 1
                end
                itemFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            end
        end
        
        library.flags[self.flag] = table.clone(self.selectedValues)
        
        -- Gọi callbacks
        self.callback(table.clone(self.selectedValues))
        if self.onChange then
            self.onChange(table.clone(self.selectedValues))
        end
        
        return true
    end
    
    function option:IsItemSelected(value)
        if self.multiSelect then
            return table.find(self.selectedValues, tostring(value)) ~= nil
        else
            return self.value == tostring(value)
        end
    end
    
    function option:GetSelectedItems()
        if self.multiSelect then
            return table.clone(self.selectedValues)
        else
            return self.value
        end
    end
    
    return option
end
	
	function parent:AddBox(option)
		option = typeof(option) == "table" and option or {}
		option.text = tostring(option.text)
		option.value = tostring(option.value or "")
		option.callback = typeof(option.callback) == "function" and option.callback or function() end
		option.type = "box"
		option.position = #self.options
		option.flag = option.flag or option.text
		library.flags[option.flag] = option.value
		table.insert(self.options, option)
		
		return option
	end
	
	function parent:AddColor(option)
    option = typeof(option) == "table" and option or {}
    option.text = tostring(option.text)
    
    -- Sửa lỗi chuyển đổi màu: xử lý cả trường hợp color là table hoặc Color3
    local color = option.color
    if typeof(color) == "table" then
        -- Đảm bảo table có đủ 3 phần tử
        if #color >= 3 then
            -- Chuyển giá trị RGB (0-255) sang khoảng (0-1) cho Color3
            option.color = Color3.fromRGB(
                math.clamp(tonumber(color[1]) or 255, 0, 255),
                math.clamp(tonumber(color[2]) or 255, 0, 255),
                math.clamp(tonumber(color[3]) or 255, 0, 255)
            )
        else
            option.color = Color3.fromRGB(255, 255, 255) -- Default white
        end
    elseif typeof(color) == "Color3" then
        option.color = color
    else
        option.color = Color3.fromRGB(255, 255, 255) -- Default white
    end
    
    option.callback = typeof(option.callback) == "function" and option.callback or function() end
    option.open = false
    option.type = "color"
    option.position = #self.options
    option.flag = option.flag or option.text
    library.flags[option.flag] = option.color
    table.insert(self.options, option)
    return option
end
	
	function parent:AddFolder(title)
		local option = {}
		option.title = tostring(title)
		option.options = {}
		option.open = false
		option.type = "folder"
		option.position = #self.options
		table.insert(self.options, option)
		
		getFnctions(option)
		
		function option:init()
			createOptionHolder(self.title, parent.content, self, true)
			loadOptions(self, parent)
		end
		
		return option
	end
end

function library:CreateWindow(title)
	local window = {title = tostring(title), options = {}, open = true, canInit = true, init = false, position = #self.windows}
	getFnctions(window)
	
	table.insert(library.windows, window)
	
	return window
end

local UIToggle
function library:Init()
	self.base = self.base or self:Create("ScreenGui")
	if syn and syn.protect_gui then
		syn.protect_gui(self.base)
	elseif get_hidden_gui then
		get_hidden_gui(self.base)
	elseif gethui then
		gethui(self.base)
	else
		game:GetService"Players".LocalPlayer:Kick("Error: protect_gui function not found")
		return
	end
	self.base.Parent = game:GetService"CoreGui"
	self.base.ResetOnSpawn = true
	self.base.Name = "ToraScript"
	
	
	for _, window in next, self.windows do
		if window.canInit and not window.init then
			window.init = true
			createOptionHolder(window.title, self.base, window)
			loadOptions(window)
		end
	end
	return self.base
end

function library:Close()
	if typeof(self.base) ~= "Instance" then end
	self.open = not self.open
	if self.activePopup then
		self.activePopup:Close()
	end
	for _, window in next, self.windows do
		if window.main then
			window.main.Visible = self.open
		end
	end
end

inputService.InputBegan:connect(function(input)
	if input.UserInputType == ui then
		if library.activePopup then
			if input.Position.X < library.activePopup.mainHolder.AbsolutePosition.X or input.Position.Y < library.activePopup.mainHolder.AbsolutePosition.Y then
				library.activePopup:Close()
			end
		end
		if library.activePopup then
			if input.Position.X > library.activePopup.mainHolder.AbsolutePosition.X + library.activePopup.mainHolder.AbsoluteSize.X or input.Position.Y > library.activePopup.mainHolder.AbsolutePosition.Y + library.activePopup.mainHolder.AbsoluteSize.Y then
				library.activePopup:Close()
			end
		end
	elseif input.UserInputType == Enum.UserInputType.Touch then
		if library.activePopup then
			if input.Position.X < library.activePopup.mainHolder.AbsolutePosition.X or input.Position.Y < library.activePopup.mainHolder.AbsolutePosition.Y then
				library.activePopup:Close()
			end
		end
		if library.activePopup then
			if input.Position.X > library.activePopup.mainHolder.AbsolutePosition.X + library.activePopup.mainHolder.AbsoluteSize.X or input.Position.Y > library.activePopup.mainHolder.AbsolutePosition.Y + library.activePopup.mainHolder.AbsoluteSize.Y then
				library.activePopup:Close()
			end
		end
	end
end)

inputService.InputChanged:connect(function(input)
	if input == dragInput and dragging then
		update(input)
	end
end)

wait(1)
local VirtualUser=game:service'VirtualUser'
game:service('Players').LocalPlayer.Idled:connect(function()
VirtualUser:CaptureController()
VirtualUser:ClickButton2(Vector2.new())
end)

return library
